{% extends "base.html" %}
{% block content %}
<h2>聚餐投票</h2>

{% if not group %}
  <div class="cta-wrap" style="margin:12px 0;">
    <a class="cta" href="{{ url_for('group_new', scope='vote', next_page='vote') }}">➕ 新增群組</a>
    <a class="cta secondary" href="{{ url_for('group_join', scope='vote', next_page='vote') }}">🔑 輸入群組邀請代碼</a>
  </div>
  <p class="muted">請先建立或輸入群組代碼，才能進行投票。</p>
{% else %}
  <p class="muted" style="margin:8px 0;">
    群組代碼：<strong>{{ group.code }}</strong>{% if group.name %}（{{ group.name }}）{% endif %}
  </p>

  {% if meta %}
    <p class="muted" style="margin:4px 0;">
      每人可投：<strong>{{ meta.votes_per_person }}</strong> 票
      · 投票截止：<strong>{{ meta.vote_deadline | tw_time }}</strong>
      {% if is_closed %}<span class="tag">已截止</span>{% endif %}
    </p>
  {% endif %}

  <div class="two-col">
    <div class="main">
      <p style="margin:8px 0;">
        <a href="{{ url_for('vg_add_restaurant', code=group.code) }}">➕ 新增餐廳</a>
        ·
        <a href="{{ url_for('vg_manage_restaurants', code=group.code) }}">🗑️ 刪除餐廳</a>
      </p>

      <div class="grid grid-4 restaurants-grid" style="margin-top:12px;">
        {% for r in restaurants %}
        <div class="card restaurant-card">
          <div class="card-head">
            <h3 class="title">
              {% if is_closed and winner_ids and r.id in winner_ids %}👑 {% endif %}
              {{ r.name }}
            </h3>
            <div class="votes">票數：{{ votes.get(r.id, 0) }}</div>
          </div>

          <p>☎️ {{ r.phone or '—' }}</p>
          <p>🕒 {{ r.hours or '—' }}</p>
          {% if r.menu_url %}
            <p><a href="{{ r.menu_url }}" target="_blank" rel="noopener">📋 菜單</a></p>
          {% endif %}

          {% if not is_closed %}
            <form action="{{ url_for('vote_restaurant', code=group.code, vote_restaurant_id=r.id) }}" method="post">
              <button type="submit">我要投這家</button>
            </form>
          {% else %}
            <p class="muted">投票已截止</p>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>

    <aside class="sidebar">
      {% include "partials/comment_panel.html" %}
    </aside>
  </div>
{% endif %}
{% endblock %}
